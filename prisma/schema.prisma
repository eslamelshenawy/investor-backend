// Prisma Schema for Investor Radar
// نظام رادار المستثمر - قاعدة البيانات

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// المستخدمين - Users
// ═══════════════════════════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  nameAr        String?   @map("name_ar")
  avatar        String?
  role          String    @default("USER")
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  bio           String?
  bioAr         String?   @map("bio_ar")
  phone         String?
  location      String?
  locationAr    String?   @map("location_ar")
  skills        String?   // JSON array string e.g. '["التحليل المالي","التداول"]'
  coverImage    String?   @map("cover_image")

  // 2FA
  twoFactorEnabled Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?   @map("two_factor_secret")
  twoFactorBackup  String?   @map("two_factor_backup") // JSON array of backup codes

  // OAuth / SSO
  provider         String?   // google, github, etc.
  providerId       String?   @map("provider_id")

  // Relations
  dashboards    Dashboard[]
  favorites     Favorite[]
  notifications Notification[]
  contents      Content[]      @relation("ContentAuthor")
  comments      Comment[]
  contentLikes  ContentLike[]
  contentSaves  ContentSave[]
  following     Follow[]       @relation("FollowingUser")
  followers     Follow[]       @relation("FollowedUser")
  passwordResets PasswordResetToken[]

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// ═══════════════════════════════════════════════════════════════════════════════
// لوحات البيانات المخصصة - Custom Dashboards
// ═══════════════════════════════════════════════════════════════════════════════

model Dashboard {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String
  nameAr      String?   @map("name_ar")
  description String?
  widgets     String    @default("[]")
  layout      String    @default("{}")
  isPublic    Boolean   @default(false) @map("is_public")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("dashboards")
}

// ═══════════════════════════════════════════════════════════════════════════════
// المفضلات - Favorites
// ═══════════════════════════════════════════════════════════════════════════════

model Favorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  itemType  String   @map("item_type")
  itemId    String   @map("item_id")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, itemType, itemId])
  @@map("favorites")
}

// ═══════════════════════════════════════════════════════════════════════════════
// الإشارات الذكية - AI Signals
// ═══════════════════════════════════════════════════════════════════════════════

model Signal {
  id           String    @id @default(cuid())
  type         String
  title        String
  titleAr      String    @map("title_ar")
  summary      String
  summaryAr    String    @map("summary_ar")
  details      String    @default("{}")
  impactScore  Float     @map("impact_score")
  confidence   Float
  trend        String
  dataSource   String    @map("data_source")
  datasetId    String?   @map("dataset_id")
  region       String?
  sector       String?
  isActive     Boolean   @default(true) @map("is_active")

  createdAt    DateTime  @default(now()) @map("created_at")
  expiresAt    DateTime? @map("expires_at")

  @@map("signals")
}

// ═══════════════════════════════════════════════════════════════════════════════
// المحتوى التلقائي - AI Generated Content
// ═══════════════════════════════════════════════════════════════════════════════

model Content {
  id           String    @id @default(cuid())
  type         String
  title        String
  titleAr      String    @map("title_ar")
  body         String
  bodyAr       String    @map("body_ar")
  excerpt      String?
  excerptAr    String?   @map("excerpt_ar")
  tags         String    @default("[]")
  metadata     String    @default("{}")
  status       String    @default("PUBLISHED")
  viewCount    Int       @default(0) @map("view_count")
  likeCount    Int       @default(0) @map("like_count")
  saveCount    Int       @default(0) @map("save_count")
  commentCount Int       @default(0) @map("comment_count")
  shareCount   Int       @default(0) @map("share_count")

  // Author & Workflow
  authorId     String?   @map("author_id")
  author       User?     @relation("ContentAuthor", fields: [authorId], references: [id])
  reviewerId   String?   @map("reviewer_id")
  reviewNote   String?   @map("review_note")
  reviewNoteAr String?   @map("review_note_ar")
  scheduledAt  DateTime? @map("scheduled_at")
  isPinned     Boolean   @default(false) @map("is_pinned")

  // Relations
  datasetId    String?   @map("dataset_id")
  likes        ContentLike[]
  comments     Comment[]
  saves        ContentSave[]

  generatedAt  DateTime  @default(now()) @map("generated_at")
  publishedAt  DateTime? @map("published_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("content")
}

// ═══════════════════════════════════════════════════════════════════════════════
// إعجابات المحتوى - Content Likes
// ═══════════════════════════════════════════════════════════════════════════════

model ContentLike {
  id        String   @id @default(cuid())
  contentId String   @map("content_id")

  // Can be null for anonymous likes (tracked by session/IP)
  userId    String?  @map("user_id")
  sessionId String?  @map("session_id")

  // Relations
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([contentId, userId])
  @@unique([contentId, sessionId])
  @@map("content_likes")
}

// ═══════════════════════════════════════════════════════════════════════════════
// مجموعات البيانات - Datasets
// ═══════════════════════════════════════════════════════════════════════════════

model Dataset {
  id            String    @id @default(cuid())
  externalId    String    @unique @map("external_id")
  name          String
  nameAr        String    @map("name_ar")
  description   String?
  descriptionAr String?   @map("description_ar")
  category      String
  source        String    @default("open.data.gov.sa")
  sourceUrl     String?   @map("source_url")

  // Data info
  recordCount   Int       @default(0) @map("record_count")
  columns       String    @default("[]")
  dataPreview   String    @default("[]") @map("data_preview")

  // Resources - روابط الملفات (CSV, Excel, JSON)
  resources     Json      @default("[]") @map("resources")

  // Metadata - البيانات الوصفية الكاملة من المصدر
  metadata      Json?     @map("metadata")

  // Data URL - رابط البيانات المباشر
  dataUrl       String?   @map("data_url")

  // Sync info
  lastSyncAt    DateTime? @map("last_sync_at")
  syncStatus    String    @default("PENDING") @map("sync_status")
  syncError     String?   @map("sync_error")

  isActive      Boolean   @default(true) @map("is_active")

  // Verification
  verificationStatus  String    @default("UNVERIFIED") @map("verification_status")
  verifiedBy          String?   @map("verified_by")
  verifiedAt          DateTime? @map("verified_at")
  verificationNote    String?   @map("verification_note")
  verificationNoteAr  String?   @map("verification_note_ar")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("datasets")
}

// ═══════════════════════════════════════════════════════════════════════════════
// بيانات الـ Dataset - Dataset Records
// ═══════════════════════════════════════════════════════════════════════════════

model DataRecord {
  id          String   @id @default(cuid())
  datasetId   String   @map("dataset_id")
  data        String
  hash        String   // For deduplication

  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([datasetId, hash])
  @@map("data_records")
}

// ═══════════════════════════════════════════════════════════════════════════════
// سجل المزامنة - Sync Logs
// ═══════════════════════════════════════════════════════════════════════════════

model SyncLog {
  id             String    @id @default(cuid())
  datasetId      String?   @map("dataset_id")
  jobType        String    @map("job_type")
  status         String
  recordsCount   Int       @default(0) @map("records_count")
  newRecords     Int       @default(0) @map("new_records")
  updatedRecords Int       @default(0) @map("updated_records")
  duration       Int?      // milliseconds
  error          String?
  metadata       String    @default("{}")

  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")

  @@map("sync_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// الإشعارات - Notifications
// ═══════════════════════════════════════════════════════════════════════════════

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String
  title     String
  titleAr   String   @map("title_ar")
  message   String
  messageAr String   @map("message_ar")
  data      String   @default("{}")
  isRead    Boolean  @default(false) @map("is_read")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

// ═══════════════════════════════════════════════════════════════════════════════
// إعدادات النظام - System Settings
// ═══════════════════════════════════════════════════════════════════════════════

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  groupName String   @default("general") @map("group_name")

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ═══════════════════════════════════════════════════════════════════════════════
// التعليقات - Comments
// ═══════════════════════════════════════════════════════════════════════════════

model Comment {
  id        String    @id @default(cuid())
  contentId String    @map("content_id")
  userId    String    @map("user_id")
  parentId  String?   @map("parent_id")
  body      String
  bodyAr    String?   @map("body_ar")
  isEdited  Boolean   @default(false) @map("is_edited")

  // Relations
  content   Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("comments")
}

// ═══════════════════════════════════════════════════════════════════════════════
// حفظ المحتوى - Content Saves/Bookmarks
// ═══════════════════════════════════════════════════════════════════════════════

model ContentSave {
  id        String   @id @default(cuid())
  contentId String   @map("content_id")
  userId    String   @map("user_id")

  // Relations
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([contentId, userId])
  @@map("content_saves")
}

// ═══════════════════════════════════════════════════════════════════════════════
// سجل التدقيق - Audit Logs
// ═══════════════════════════════════════════════════════════════════════════════

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String   @map("actor_id")
  action     String
  targetType String   @map("target_type")
  targetId   String   @map("target_id")
  details    String   @default("{}")

  createdAt  DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// الجهات والخبراء - Entities & Experts
// ═══════════════════════════════════════════════════════════════════════════════

model Entity {
  id                String    @id @default(cuid())
  name              String
  nameEn            String?   @map("name_en")
  role              String
  type              String    // ministry, authority, expert, analyst
  location          String?
  avatar            String?
  coverImage        String?   @map("cover_image")
  isVerified        Boolean   @default(false) @map("is_verified")
  verificationLevel String    @default("none") @map("verification_level") // official, verified, none
  specialties       String    @default("[]") // JSON array
  description       String?
  website           String?
  establishedYear   String?   @map("established_year")
  impact            String    @default("medium") // critical, high, medium, low
  isActive          Boolean   @default(true) @map("is_active")

  // Stats (denormalized for performance)
  followersCount    Int       @default(0) @map("followers_count")
  postsCount        Int       @default(0) @map("posts_count")
  datasetsCount     Int       @default(0) @map("datasets_count")

  // Relations
  entityFollows     Follow[]  @relation("FollowedEntity")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("entities")
}

// ═══════════════════════════════════════════════════════════════════════════════
// المتابعة - Follows (User→User, User→Entity)
// ═══════════════════════════════════════════════════════════════════════════════

model Follow {
  id             String    @id @default(cuid())
  followerId     String    @map("follower_id")
  followType     String    @map("follow_type") // USER, ENTITY
  followedUserId String?   @map("followed_user_id")
  followedEntityId String? @map("followed_entity_id")

  // Relations
  follower       User      @relation("FollowingUser", fields: [followerId], references: [id], onDelete: Cascade)
  followedUser   User?     @relation("FollowedUser", fields: [followedUserId], references: [id], onDelete: Cascade)
  followedEntity Entity?   @relation("FollowedEntity", fields: [followedEntityId], references: [id], onDelete: Cascade)

  createdAt      DateTime  @default(now()) @map("created_at")

  @@unique([followerId, followType, followedUserId])
  @@unique([followerId, followType, followedEntityId])
  @@map("follows")
}

// ═══════════════════════════════════════════════════════════════════════════════
// رموز استعادة كلمة المرور - Password Reset Tokens
// ═══════════════════════════════════════════════════════════════════════════════

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}
